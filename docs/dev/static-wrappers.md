---
layout: default
title: Static Wrappers
---

# Static wrappers — nvm and rbenv

> Sources: `scripts/bin/node_wrappers/nvm`, `scripts/bin/ruby_wrappers/rbenv`

Most wrapped binaries (node, npm, ruby, gem, etc.) are regular executables that can be replaced with `exec`. The version managers themselves need special treatment.

## Why they are special

| Manager | Reason                                                                                                                                                                  |
| ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nvm`   | It is a **shell function**, not a binary. You cannot `exec` a function — it only exists in the shell's memory after sourcing `nvm.sh`.                                  |
| `rbenv` | While it has a binary at `~/.rbenv/bin/rbenv`, it requires `rbenv init` to set up shims and a shell function wrapper. The static wrapper ensures proper initialization. |

These wrappers are hand-crafted (not generated by `generate_wrappers`) and are copied as-is during installation. The generator skips them via the `STATIC_WRAPPERS` array.

---

## nvm static wrapper

### Flow

```
User types: nvm install 18
    │
    ▼
node_wrappers/nvm (this wrapper)
    ├── Recursion guard (_LW_NVM_LOADING)
    ├── Remove node_wrappers/ from PATH
    ├── Source nvm.sh directly
    │   ├── Success → nvm function now exists
    │   └── Fail → try nvmload (which may clone nvm first)
    ├── Touch flag file for shell-hook
    └── Call nvm function (NOT exec)
        └── nvm install 18
```

### No exec

```bash
# Regular generated wrapper:
exec node "$@"         # replaces process with binary

# nvm static wrapper:
nvm "$@"               # calls shell function in-process
```

Since `nvm` is a function defined by sourcing `nvm.sh`, it only exists within the current process. `exec` would look for an `nvm` executable in PATH (which does not exist), so the wrapper calls the function directly.

### Two-stage loading

```bash
if [[ -s "$NVM_DIR/nvm.sh" ]]; then
    . "$NVM_DIR/nvm.sh"                    # Stage 1: nvm already installed
else
    SCRIPT_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
    if [[ -f "$SCRIPT_DIR/nvmload" ]]; then
        unset NVM_ALREADY_LOADED            # Allow nvmload to run
        . "$SCRIPT_DIR/nvmload"             # Stage 2: clone + install
    fi
fi
```

- **Stage 1:** If `nvm.sh` exists, source it directly (fastest path).
- **Stage 2:** If nvm is not installed, use `nvmload` which clones it from GitHub first.

The `unset NVM_ALREADY_LOADED` before sourcing `nvmload` ensures the loader does not early-exit.

### Final verification

```bash
if declare -f nvm &>/dev/null; then
    nvm "$@"
else
    echo "Error: nvm failed to load..." >&2
    exit 1
fi
```

`declare -f nvm` checks if the `nvm` function is defined. This is the correct way to verify a shell function (vs `command -v` which works for binaries and builtins).

---

## rbenv static wrapper

### Flow

```
User types: rbenv install 3.3.0
    │
    ▼
ruby_wrappers/rbenv (this wrapper)
    ├── Recursion guard (_LW_RBENV_LOADING)
    ├── Remove ruby_wrappers/ from PATH
    ├── command -v rbenv → not found?
    │   └── Source rbenvload (clones + initializes)
    ├── Touch flag file for shell-hook
    └── exec rbenv "$@"   ← CAN use exec (rbenv is a real binary)
```

### Loading logic

```bash
if ! command -v rbenv &>/dev/null; then
    SCRIPT_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
    if [[ -f "$SCRIPT_DIR/rbenvload" ]]; then
        . "$SCRIPT_DIR/rbenvload"
    fi
fi
```

Simpler than the nvm wrapper — just checks if `rbenv` is available and loads it if not. Since `rbenv` is a real binary, `exec rbenv "$@"` works.

---

## Comparison: static vs generated

| Aspect                | Static (nvm, rbenv)                | Generated (node, npm, etc.)  |
| --------------------- | ---------------------------------- | ---------------------------- |
| Created by            | Hand-crafted in repo               | `generate_wrappers` template |
| Copied during install | Yes (explicit copy)                | Generated at install time    |
| Uses `exec`           | nvm: no (function), rbenv: yes     | Yes                          |
| Loader                | Direct source or nvmload/rbenvload | nvmload or rbenvload         |
| Skipped by generator  | Yes (`STATIC_WRAPPERS` array)      | N/A                          |
| PATH resolution       | `$(dirname "$0")` at runtime       | Hardcoded absolute paths     |

### Path resolution difference

Static wrappers use runtime path resolution:

```bash
WRAPPER_DIR="$(cd "$(dirname "$0")" && pwd)"
```

Generated wrappers use install-time absolute paths:

```bash
WRAPPER_DIR="/home/user/.lazy-wrappers/scripts/bin/node_wrappers"
```

The static approach is more portable (works if the install dir moves). The generated approach avoids the overhead of `cd`/`dirname`/`pwd` on every invocation.
