#!/bin/bash
# Shell hook for lazy-wrappers
# This runs after each command and removes wrapper directories from PATH
# once the corresponding version manager has been loaded, replacing them
# with the actual version manager paths

# Resolve paths dynamically from this script's location
# shell_hook lives at <install_dir>/scripts/shell_hook
if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
    __LAZY_WRAPPERS_HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    # zsh: $0 is the sourced file path when sourcing
    __LAZY_WRAPPERS_HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
fi
__LAZY_WRAPPERS_NODE_DIR="$__LAZY_WRAPPERS_HOOK_DIR/bin/node_wrappers"
__LAZY_WRAPPERS_RUBY_DIR="$__LAZY_WRAPPERS_HOOK_DIR/bin/ruby_wrappers"

# Use flag files to track which version managers have been loaded
__LAZY_WRAPPERS_FLAGS_DIR="${XDG_RUNTIME_DIR:-/tmp}/lazy-wrappers-$$"

__lazy_wrappers_cleanup() {
    # Remove node_wrappers from PATH and load nvm into this shell if flag exists
    if [[ -f "$__LAZY_WRAPPERS_FLAGS_DIR/nvm_loaded" && "$PATH" == *"node_wrappers"* ]]; then
        PATH=":$PATH:"
        while [[ "$PATH" == *":$__LAZY_WRAPPERS_NODE_DIR:"* ]]; do
            PATH="${PATH//:$__LAZY_WRAPPERS_NODE_DIR:/:}"
        done
        PATH="${PATH#:}"
        PATH="${PATH%:}"
        # Load nvm into this shell if not already loaded
        if [[ -z "${NVM_ALREADY_LOADED:-}" ]]; then
            export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
            [[ -s "$NVM_DIR/nvm.sh" ]] && . "$NVM_DIR/nvm.sh"
            export NVM_ALREADY_LOADED=1
        fi
        export PATH
    fi
    
    # Remove ruby_wrappers from PATH and load rbenv into this shell if flag exists
    if [[ -f "$__LAZY_WRAPPERS_FLAGS_DIR/rbenv_loaded" && "$PATH" == *"ruby_wrappers"* ]]; then
        PATH=":$PATH:"
        while [[ "$PATH" == *":$__LAZY_WRAPPERS_RUBY_DIR:"* ]]; do
            PATH="${PATH//:$__LAZY_WRAPPERS_RUBY_DIR:/:}"
        done
        PATH="${PATH#:}"
        PATH="${PATH%:}"
        # Load rbenv into this shell if not already loaded
        if [[ -z "${RBENV_ALREADY_LOADED:-}" ]]; then
            export RBENV_DIR="${RBENV_DIR:-$HOME/.rbenv}"
            if [[ -x "$RBENV_DIR/bin/rbenv" ]]; then
                eval "$("$RBENV_DIR/bin/rbenv" init - "${ZSH_VERSION:+zsh}" "${BASH_VERSION:+bash}")"
                export RBENV_ALREADY_LOADED=1
            fi
        fi
        export PATH
    fi
}

# Create the flags directory for this shell session
mkdir -p "$__LAZY_WRAPPERS_FLAGS_DIR" 2>/dev/null

# Clean up flags directory on shell exit
trap 'rm -rf "$__LAZY_WRAPPERS_FLAGS_DIR" 2>/dev/null' EXIT

# Install the hook based on shell type
if [[ -n "$ZSH_VERSION" ]]; then
    # Zsh: use precmd hook
    autoload -Uz add-zsh-hook
    add-zsh-hook precmd __lazy_wrappers_cleanup
elif [[ -n "$BASH_VERSION" ]]; then
    # Bash: use PROMPT_COMMAND
    if [[ "$PROMPT_COMMAND" != *"__lazy_wrappers_cleanup"* ]]; then
        PROMPT_COMMAND="__lazy_wrappers_cleanup${PROMPT_COMMAND:+; $PROMPT_COMMAND}"
    fi
fi

# Export the flags dir so wrappers can use it
export __LAZY_WRAPPERS_FLAGS_DIR
