#!/bin/bash
# Static wrapper for rbenv
# This wrapper ensures rbenv is properly loaded before running

FLAGS_DIR="${_LW_FLAGS_DIR:-${__LAZY_WRAPPERS_FLAGS_DIR:-}}"

# Prevent infinite recursion
if [[ -n "${__LAZY_WRAPPERS_RBENV_LOADING:-}" ]]; then
    echo "Error: rbenv wrapper recursion detected. Check your PATH configuration." >&2
    exit 1
fi
export __LAZY_WRAPPERS_RBENV_LOADING=1

# Remove ALL occurrences of wrapper directory from PATH to prevent recursion
WRAPPER_DIR="$(cd "$(dirname "$0")" && pwd)"
PATH=":$PATH:"
while [[ "$PATH" == *":$WRAPPER_DIR:"* ]]; do
    PATH="${PATH//:$WRAPPER_DIR:/:}"
done
PATH="${PATH#:}"
PATH="${PATH%:}"
export PATH

# Load rbenv if not already available
if ! command -v rbenv &>/dev/null; then
    SCRIPT_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
    if [[ -f "$SCRIPT_DIR/rbenvload" ]]; then
        . "$SCRIPT_DIR/rbenvload"
    fi
fi

# Create flag file so shell_hook removes wrapper dir from parent shell PATH
if [[ -n "${FLAGS_DIR:-}" ]]; then
    touch "$FLAGS_DIR/rbenv_loaded" 2>/dev/null || true
fi

# rbenv should now be available - run it
if command -v rbenv &>/dev/null; then
    exec rbenv "$@"
else
    echo "Error: rbenv failed to load" >&2
    exit 1
fi
