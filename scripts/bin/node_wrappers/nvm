#!/bin/bash
# Static wrapper for nvm
# nvm is a shell function, not an executable, so we can't use 'exec'
# This wrapper sources nvm.sh and then calls the nvm function

FLAGS_DIR="${_LW_FLAGS_DIR:-${__LAZY_WRAPPERS_FLAGS_DIR:-}}"

# Prevent infinite recursion
if [[ -n "${__LAZY_WRAPPERS_NVM_LOADING:-}" ]]; then
    echo "Error: nvm wrapper recursion detected. Check your PATH configuration." >&2
    exit 1
fi
export __LAZY_WRAPPERS_NVM_LOADING=1

# Remove ALL occurrences of wrapper directory from PATH to prevent recursion
WRAPPER_DIR="$(cd "$(dirname "$0")" && pwd)"
PATH=":$PATH:"
while [[ "$PATH" == *":$WRAPPER_DIR:"* ]]; do
    PATH="${PATH//:$WRAPPER_DIR:/:}"
done
PATH="${PATH#:}"
PATH="${PATH%:}"
export PATH

# Load nvm.sh directly - nvm is a shell function, not a binary
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"

if [[ -s "$NVM_DIR/nvm.sh" ]]; then
    # Source nvm.sh to get the nvm function
    . "$NVM_DIR/nvm.sh"
    export NVM_ALREADY_LOADED=1
    # Create flag file so shell_hook removes wrapper dir from parent shell PATH
    if [[ -n "${FLAGS_DIR:-}" ]]; then
        touch "$FLAGS_DIR/nvm_loaded" 2>/dev/null || true
    fi
else
    # nvm not installed - try to install it via nvmload
    SCRIPT_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
    if [[ -f "$SCRIPT_DIR/nvmload" ]]; then
        unset NVM_ALREADY_LOADED  # Allow nvmload to run
        . "$SCRIPT_DIR/nvmload"
    fi
fi

# nvm must be a function at this point - call it
if declare -f nvm &>/dev/null; then
    nvm "$@"
else
    echo "Error: nvm failed to load. Ensure nvm is installed at $NVM_DIR" >&2
    echo "You can install it with: git clone https://github.com/nvm-sh/nvm.git \"\$NVM_DIR\"" >&2
    exit 1
fi
